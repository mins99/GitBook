# 아이템8 - finalizer와 cleaner 사용을 피하라

## 자바는 두 가지 객체 소멸자를 제공한다

### 1. finalizer

* 예측할 수 없고, 상황에 따라 위험할 수 있어 일반적으로 불필요하다
* 나름의 쓰임새가 있지만 기본적으로는 '쓰지 말아야' 함
* 자바 9에서 deprecated됨

### 2. cleaner

* finalizer의 대안으로 등장하여 덜 위험하다
* 여전히 예측할 수 없고, 느리고, 일반적으로 불필요하다

## finalizer와 cleaner의 단점

### 1. finalizer와 cleaner는 즉시 수행된다는 보장이 없다

* 객체에 접근할 수 없게 된 후 이 객체 소멸자들이 실행되기까지 얼마나 걸릴 지 알 수 없다
* 즉, 제때 실행되어야 하는 작업은 절대 할 수 없다
  * ex) 파일 닫기 - 시스템이 동시에 열 수 있는 파일 개수에 한계가 있기 때문

### 2. 인스턴스의 자원 회수가 제멋대로 지연될 수 있다

* finalizer 스레드는 다른 애플리케이션 스레드보다 우선 순위가 낮아서 실행될 기회를 제대로 얻지 못할 수 있다
* cleaner는 자신을 수행할 스레드를 제어할 수는 있지만, 백그라운드에서 수행되며 가비지 컬렉터의 통제하에 있어 즉각 수행되리라는 보장이 없다

### 3. 수행 시점뿐 아니라 수행 여부조차 보장하지 않는다

* 접근할 수 없는 객체에 대한 종료 작업을 전혀 수행하지 못한 채 프로그램이 중단될 수 있다
* 상태를 영구적으로 수정하는 작업에서는 절대 사용하면 안된다
  * ex) DB와 같은 공유 자원의 영구 lock 해제

### 4. 동작 중 발생한 예외가 무시된다

* finalizer는 동작 중 발생한 예외는 무시되며, 처리할 작업이 남았더라도 그 순간 종료된다
  * 예외를 잡지 못하면 해당 객체는 훼손될 수 있고, 다른 스레드가 이 훼손된 객체를 사용시 어떻게 동작할 지 예측할 수 없다
  * 보통은 스레드를 중단시키고 스택 추적 내역을 출력하지만, finalizer는 이런 경우 경고조차 출력하지 않는다
* cleaner는 자신의 스레드를 통제하기 때문에 이러한 문제는 발생하지 않는다

### 5. 성능 문제로 가비지 컬렉터의 효율을 떨어뜨린다

* 다른 방법(AutoCloseable)에 비해 객체를 생성하고 파괴하는 시간이 오래걸림

### 6. 보안 문제를 일으킬 수 있다

* 생성자나 직렬화 과정에서 예외가 발생하면 finalizer가 수행되는데, 이 finalizer를 오버라이딩한 하위클래스의 finalizer가 수행될 수 있다
* 심지어, 이 finalizer를 static 필드에 할당하면 가비지 컬렉터에 의해 수거되지도 않는다

## finalizer와 cleaner의 대안 - AutoCloseable

* `AutoCloseable`을 구현해주고, 클라이언트에서 인스턴스를 다 쓰고 나면 `close` 메서드를 호출하면 된다
* 추가로 구체적인 구현법과 관련하여 각 인스턴스는 자신이 닫혔는지를 추적하는 것이 좋다

## 그럼 대체 언제 쓸까?

### 1. 자원의 소유자가 close 메서드를 호출하지 않는 것에 대한 대비하는 안전망

* 호출되리라는 보장은 없지만, 클라이언트가 하지 않은 자원 회수를 늦게라도 해주는 것이 나으므로
* FileInputStream, FileOutputStream, ThreadPoolExecutor

### 2. 네이티브 피어(native peer)와 연결된 객체의 GC

* 네이티브 피어 : 일반 자바 객체가 네이티브 메서드를 통해 기능을 위임한 네이티브 객체
* 자바 객체가 아니라 가비지 컬렉터가 존재를 알지 못하고 회수하지 못함
* 이 역시 성능 저하를 감당할 수 없거나 즉시 회수가 필요하다면 `close` 메서드를 사용할 것

## 핵심 정리

* cleaner(자바 8까지는 finalizer)는 안전망 역할이나 중요하지 않은 네이티브 자원 회수용으로만 사용
* 물론 이런 경우라도 불확실성과 성능 저하에 주의해야 함

참고 : [velog - 아이템 8. finalizer와 cleaner 사용을 피하라](https://velog.io/@lychee/%EC%9D%B4%ED%8E%99%ED%8B%B0%EB%B8%8C-%EC%9E%90%EB%B0%94-%EC%95%84%EC%9D%B4%ED%85%9C-8.-finalizer%EC%99%80-cleaner-%EC%82%AC%EC%9A%A9%EC%9D%84-%ED%94%BC%ED%95%98%EB%9D%BC#%EB%8B%A8%EC%A0%90-1-%EC%A6%89%EC%8B%9C-%EC%88%98%ED%96%89%EB%90%9C%EB%8B%A4%EB%8A%94-%EB%B3%B4%EC%9E%A5%EC%9D%B4-%EC%97%86%EB%8B%A4)
